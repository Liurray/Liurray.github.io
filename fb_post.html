<!DOCTYPE html>
<html>
<head>
<title>Facebook Login JavaScript Example</title>
<meta charset="UTF-8">
</head>
<body>
<script>

  function statusChangeCallback(response) {  // Called with the results from FB.getLoginStatus().
    console.log('statusChangeCallback');
    console.log(response);                   // The current login status of the person.
    if (response.status === 'connected') {   // Logged into your webpage and Facebook.
      testAPI();  
    } else {                                 // Not logged into your webpage or we are unable to tell.
      document.getElementById('status').innerHTML = 'Please log ' +
        'into this webpage.';
    }
  }
  function checkLoginState() {               // Called when a person is finished with the Login Button.
    FB.getLoginStatus(function(response) {   // See the onlogin handler
      statusChangeCallback(response);
    });
  }


  function check_premission() {     
    var body = '內容成功發布';          // Called when a person is finished with the Login Button.
    FB.getLoginStatus(function(response) { 
          console.log('login status',response);
          if(!(response.status === 'connected')){
                location.href = './fb_post.html';
              } else{
                  uID = response.authResponse.userID;  //使用者登入id
                  accessToken = response.authResponse.accessToken; //使用者登入的AccessToken
                  console.log('用戶accesstoken::',response.authResponse.accessToken);
                  FB.api('/me', {fields: 'last_name'}, {  access_token : accessToken } ,function(response) {
                        console.log(response);
                    });
                    //取的PageToken
                    if(accessToken!=null){
                      FB.api('/me/accounts','get',{  access_token : accessToken },function(response){
                          console.log('pages的回應',response);
                          if(response!=null){
                            var data = response.data;
                            pageAccessToken= data[0].access_token;
                            console.log('pageAccessToken::',pageAccessToken);
                            FB.api('/104745581854224/feed', 'post', {message :body, access_token : pageAccessToken }, function(response) {
                                    console.log('response',response)
                                    if (!response || response.error) {
                                        alert('Error occured');
                                    } else {
                                        alert('內容成功發布到粉絲團 Post ID: ' + response.id);
                                    }
                                });
                                }

                        });
                      }


    }
    
    /*FB.api('/me/permissions','GET',{} ,function(response) {
 
        console.log('Successful 授權的權限: ' + JSON.stringify(response));
        document.getElementById('premission').innerHTML =
          '授權的權限' + JSON.stringify(response);
  
    })*/
      })
}



  window.fbAsyncInit = function() {
    FB.init({
      appId      : '328675752120009',
      cookie     : true,                     // Enable cookies to allow the server to access the session.
      xfbml      : true,                     // Parse social plugins on this webpage.
      version    : 'v11.0'           // Use this Graph API version for this call.
    });


    
  };
 
  function testAPI() {                      // Testing Graph API after login.  See statusChangeCallback() for when this call is made.
    console.log('Welcome!  Fetching your information.... ');
    
    FB.api('/me' ,function(response) {
      console.log('Successful login for: ' + response.name);
      document.getElementById('status').innerHTML =
        'Thanks for logging in, 你的名字是' + response.name + '!' +'登入ID為:' + response.id;
    });
    
 
 


}
function post(){
    FB.api('/me/feed',
    'POST',
    {"message" :'網頁js發文'
    } ,
    function(response) {
      //EAAEq7clzjskBAHCJD2hZBhmfNkZBDMIRxllqpUTvJptld9YJOXrW1zsplaytKMVSZAHl826FlhXZBDIPgyu9t7pNxwBtpf83880bpjW5rQnoqXcuo4Q1Ig6i4jgpyGvonChbntvF24y6YQR1yJXyhO4v877HpvPZCWKqEKmXwR2fV6hiLaZC8e
        console.log('Successful 抓到成功發文粉絲頁貼文的流水號: ' +JSON.stringify(response));
        document.getElementById('post_record').innerHTML =
        '發文紀錄, 訊息是' + JSON.stringify(response);
    });
  }
</script>


<!-- The JS SDK Login Button -->

<fb:login-button scope="email, pages_show_list, publish_to_groups, pages_read_engagement, pages_read_user_content, pages_manage_posts, pages_manage_engagement, public_profile" onlogin="checkLoginState();">
</fb:login-button>
<button  onclick="check_premission()";>檢查權限</button>
<button  onclick="post()";>發文</button>
<div id="status">請先登入
</div>
<div id="premission">獲取的權限
</div>
<div id="post_record">發文紀錄
</div>
<!-- Load the JS SDK asynchronously -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
</body>
</html>